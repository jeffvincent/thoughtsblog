---
layout: post
title: Syncing with Rsync/Cron in Mac OS
tags:
- jobstuff
status: publish
type: post
published: true
meta:
  jabber_published: '1329404434'
---

<p><strong>nerd alert!</strong> This post chronicles a super SUPER nerdy undertaking of mine.  I'm going to try doing this more often, in the vein of putting out resources I wish I had found when embarking on such a project.</p>
<p>Dropbox is awesome.  I use it for lots of personal stuff, and we use it at Wistia for work stuff as well.  I'm also big into Time Machine - I have a 2.5TB Time Capsule at my apartment that backs up my laptop and Marisa's laptop every night.  So my data is pretty safe.  But I've always been missing a way to actually MOVE files from my work laptop (Macbook Air with 125GB SSD) to my home Mac Mini (connected by ethernet &amp; USB to the Time Capsule) without having to manually connect and drag it over.</p>
<p>I've been pretty obsessed with keeping the Macbook Air clean, so I started a directory on my Desktop called "For Other Books".  I would drag PDFs, music, and video for backing up here, and then next time I thought of it, I would transfer that to it's proper place on the Mac Mini/TC setup.</p>
<p>This worked pretty well for a while, but I wasn't using it much because it was cumbersome and annoying.  I tried moving that directory into Dropbox, but that slowed the network to a halt (as it uploaded the 1+ GB original <a href="http://wistia.com/about/company">Wistia team video</a>).  It also required an extra step, since I then had to boot up the Mac Mini and move the file from the Dropbox directory to the Desktop.  Still not awesome.</p>
<p>I did some looking around the web and came across <a href="http://lifehacker.com/196122/geek-to-live--mirror-files-across-systems-with-rsync">this article on Lifehacker</a> about using <a href="http://everythinglinux.org/rsync/">rsync</a>, a command line utility for syncing.  Some time and plenty of interesting issues later, I now have a much better set-up: every Sunday at 2am, a directory on my Desktop is synced with a directory on the Mac Mini.  It then deletes the files within the directory on the Macbook.  What follows are the steps I used to achieve this.</p>
<p>"But what about tool XYZ?" you ask.  Well I didn't try that tool, so get off my back.  Instead I looked for the most automated and open-source option I could find, mostly so I could learn how the whole thing worked.  It took me approximately 3 hours to get this all working -- most of it spent scouring the Internets each time I encountered a problem.  That's why I'm writing this post: so someone with similar inclinations and ambitions will be able to do the same thing without (as much) trouble.</p>
<p><strong>The Setup</strong></p>
<ul>
<li>Macbook Air, OS X 10.7.x</li>
<li>Mac Mini, 10.7.x</li>
<li>Time Capsule</li>
</ul>

<h2>Step 1: Setting up SSH</h2>
<p>The first step is setting up SSH between your local computer (MB Air) and the remote machine (Mac Mini).  To accomplish this even when the Macbook Air is remote, we need to set up port forwarding on the Time Capsule.  So I Screen Share into the Mac Mini and pop open Network System Preferences and the Airport Utility.  Right about <strong>now</strong> is when I discovered that the latest version of the Airport Utility deprecated advanced options (what the???).</p>
<p>Luckily, our boys at MacUpdate have maintained a link to the <a href="http://www.macupdate.com/app/mac/19858/airport-utility">old version</a>.  Downloaded version 5.6.  Ahhh, advancedy goodness.  Pop open the settings -&gt; Internet -&gt; NAT, and make sure the "Enable NAT Port Mapping Protocol" checkbox is checked.  Then click the "Configure Port Mappings..." button, and add a new device to the list.  You can leave the "service" drop-down blank, set all the ports to 22, and in the Private IP Address, I added the IP address for the Mac Mini (which you can grab from the Network System Preferences).  So now, to SSH into my Mac Mini, I can use the IP address of my Time Capsule (which you can see in the TCP/IP panel of the Airport Utility).</p>

<div class="post_image"><img src="/images/sync_w_rsync_1.png" alt="shot1"></div>
<div class="post_image"><img src="/images/sync_w_rsync_2.png" alt="shot2"></div>

<p>With that mess complete, I could now SSH into my Mac Mini from the office using a command like the one below (replacing the X's with your Time Capsule IP address):</p>

<div class="codez"><code class="terminal">ssh jvmini@XXX.XX.X.X</code></div>  

<p>I could now complete a successful rsync sync for the first time as well (command is all one line):</p>

<div class="codez"><code class="terminal">rsync -avz --progress /Users/jv/Desktop/forotherbooks/ <br/>
    jvmini@XXX.XX.X.X:/Users/jmini/Desktop/fromotherbooks</code></div>  

<h2>Step 2: Public Key Authentication</h2>  
<p>Hooray!  Since I knew I wanted to end up being able to do this automatically, entering the password each time wasn't going to be an option.  We use public key authentication for a few things in the office, so I had an idea of getting that set up, but if you are new to that game, check out <a href="http://macnugget.org/projects/publickeys/">this guide</a>.  Here's the run-down of the commands used:</p>

<div class="codez"><code class="terminal">ssh-keygen -t dsa<br /> scp ~/.ssh/id_dsa.pub jvmini@XXX.XX.X.X:.ssh/authorized_keys<br /> ssh jvmini</code></div>  

<h2>Step 3: Enter the Cron</h2>  
<p>Now I had sync set up and working, but the automated part was still missing.  For that, I needed cron.  <a href="http://en.wikipedia.org/wiki/Cron">Cron</a> is a UNIX tool for scheduling jobs - pretty cool if you want to automate stuff and have it run on schedule.  I didn't have any experience with cron at all, so it took me a little while to get a handle on it.  Basically, there are two parts: the <strong>script</strong> and the <strong>cron table</strong>.</p>  

<p>The script I wrote wasn't too complicated - essentially sync everything up, and the delete all the old files from the local directory.:</p>  

<div class="codez"><code class="terminal"> #!/bin/bash <span class="comment"># This says which interpreter you want to run the script under (in this case bash)</span><br /><br/>

    RSYNC=/usr/bin/rsync  <span class="comment"># this tells the interpreter where to find rsync (run 'which rsync' to be sure)</span><br /> 
    SSH=ssh   <span class="comment"># find SSH in the same place as rsync</span><br /> 
    LPATH=/Users/jeff/Desktop/otherbooks/   <span class="comment"># read: "where is the local computer path you wish to sync?"</span><br /> 
    RPATH=jeffmini:/Users/jeffmini/Desktop/fromotherbooks   <span class="comment"># read: "And what about the remote path?"</span><br/><br/>
   
    echo "Syncing and it feels so good" <span class="comment"># I put this mostly for myself.</span><br/><br/>
   
    $RSYNC -avz --progress $LPATH $RPATH &gt;&gt; /tmp/output.txt   <span class="comment"># this is the rsync command, and then '&gt;&gt;' tells the interp to put the output into a text file (like a log)</span><br />
    cd $LPATH   <span class="comment"># CD into the local path</span><br /> 
    rm *    <span class="comment"># delete all the files that are left in there after the sync</span><br /> 
</code></div>  

<p>I saved this under the title <em>sync_books.sh</em> and saved it for now in my Home directory.</p>  

<p>Next was setting up the cron table.  Cron table is a config file where your list of jobs are for executing.  This step was a bit tricky, since the normal command</p>  

<div class="codez"><code class="terminal">crontab -e</code></div>  

<p>Wasn't working properly for whatever reason.  I blame Apple but that's ok.  I found a workaround, which is to use the editor <a href="http://www.gentoo.org/doc/en/nano-basics-guide.xml">Nano</a>, rather than VIM, to edit the crontab file.  In retrospect, this makes sense, since Apple has been tried deprecating the use of cron in favor of something called launchd.  Anyway, here's the command for opening the crontable in Nano:</p>  

<div class="codez"><code class="terminal"> EDITOR=nano crontab -e </code></div>  

<p>This opened up the cron table, so I could add a new line to it.  Cron tables (or at least my limited understanding of them) have syntax like so:</p>  <div class="codez"><code class="terminal"> * * * * * command to be executed </code></div>  

<p>The asterisks in this case stand for [min (0-59), hour (0-23), day (1-31), month (1-12), day of week (0-7, 0 and 7 are Sunday).  A great tutorial for Cron table syntax is over at <a href="http://adminschoice.com/crontab-quick-reference">Admins Choice</a>.</p>  

<h2>Step 4: Testing</h2>  
<p>Since I was setting up the cron job to run once a week (2am Sundays), I didn't want to wait that long to make sure it worked.  A one-line addition to my cron table file ran the cron script immediately:</p>  
<div class="codez"><code class="terminal"> */1 * * * * /Users/jv/sync_books.sh </code></div>  
<p>And then running a tail command in the terminal, to track updates to that "output.txt" file:</p>  
<div class="codez"><code class="terminal">tail -f output.txt</code></div>  
<p>And a minute later, voila! Syncing was complete!  Now I can dump all the stuff I want to access on the Mac Mini (or archive) without clogging the network, or dumping it into the Time Machine abyss.  Enjoy, and let me know if you have any questions!</p>
