---
layout: post
title: Setting Up HTML Emails in Rails
tags:
- jobstuff
status: publish
type: post
published: true
meta:
  jabber_published: '1340294390'
---
<p>A few weeks ago we decided to step up our email game. We had just received the masterclass in designing emails from Justine (<a href="https://twitter.com/#!/meladorri" target="_blank">@meladorri</a>) and were about to launch our <a href="http://wistia.com/free/new" target="_blank">free plan</a>, so the timing seemed right.&nbsp;It's not that they looked sooo bad in the past, but we wanted a more unified theme that could be used for our many purposes (appearance and design is more of&nbsp;<a href="https://twitter.com/#!/jringenberg" target="_blank">Joe's</a>&nbsp;area, so I'll let him write more on that).</p>  <p>We send two types of emails - some that are general reference and informational (think newsletters) that we use email marketing tools like <a href="http://mailchimp.com" title="MailChimp" target="_blank">MailChimp</a> and <a href="http://pardot.com" title="Pardot" target="_blank">Pardot</a>&nbsp;for, and some that are more personalized or time-sensitive for our customers (think overage alerts) that are sent via Rails. &nbsp;So the challenge was two-fold - get the emails looking right in an email marketing tool, but also make sure they looked consistent coming out of Rails.</p>  <p>After Joe toiled on&nbsp;a beautiful, table-based layout (you have to use tables for good looking email, it's terrible) and added it to our email marketing software without much trouble, the next challenge was porting that to the system-based emails.</p>  <p>Long story short - sending out HTML email is pretty tricky. There are some best practices for creating HTML emails (examples: <a href="http://net.tutsplus.com/tutorials/html-css-techniques/20-email-design-best-practices-and-resources-for-beginners/" target="_blank">NetTuts</a>, <a href="http://kb.mailchimp.com/article/how-to-code-html-emails" target="_blank">MailChimp</a>, and pretty much anything by <a href="http://litmus.com/" target="_blank">Litmus</a> ) but all of them involve painful stuff like inline styling and duplicate code. After much painful research and experimentation, I've got a few tips to help set up AND maintain great looking emails in Rails. It relies on a few gems and some basic Rails functionality, but it's guaranteed to make your email life a lot easier.</p>  

<h2>Step 1: Set up the mailers</h2><p>The first thing you need to do is set up Mailers and Views for the email you'd like to send out. There are much better tutorials around this part than I can provide, and they are fairly straightforward to generate in Rails:</p>  <div class="codez"><code class="terminal">rails generate mailer name_of_email_campaign name(s)_of_email</code></div>  <p><div class='post_image'> <a href="http://getfile9.posterous.com/getfile/files.posterous.com/temp-2012-06-20/GAdgdGwcdBygrctmyhzdgbBoJpbphGqpyxvrlkgibxCJgqgGFasucuhkdDdD/example_mailers.tiff.scaled1000.jpg"><img alt="Example_mailers" height="165" src="http://getfile2.posterous.com/getfile/files.posterous.com/temp-2012-06-20/GAdgdGwcdBygrctmyhzdgbBoJpbphGqpyxvrlkgibxCJgqgGFasucuhkdDdD/example_mailers.tiff.scaled500.jpg" width="500" /></a> </div> <br /> This will create a mailer model in your 'app/mailers' directory, and corresponding views (in text.erb) for the emails attached to that model. Since you'll be using layouts, I recommend editing the text version first (to get the wording right) before setting up the .html.erb version of your email.</p>  <p>&nbsp;</p>  
  
<h2>Step 2: Set up MailCatcher</h2><p>Now that you've been messing with your text emails, you probably want to see what they would look like sent, right? No need to deploy and then execute actions to generate the emails (dangerous!) - using a gem called MailCatcher and Rails functionality, you can do this painlessly (and fast!).</p>

<div class='float_left'><a href="http://mailcatcher.me/"><img alt="Png" height="123" src="http://jvincent.files.wordpress.com/2012/06/png-scaled500.png?w=124" width="124" /></a></div>
<p><a href="http://mailcatcher.me/"><strong>MailCatcher</a></strong> makes testing your Rails-based emails super easy.  Install the gem (<em>'gem install mailcatcher'</em>), run it (<em>'mailcatcher -f'</em>), and then open a browser tab to localhost:1080 to start seeing mailer magic! More info on generating an email to show up here to come. You don't need to add it to a gemfile, unless others in your team will be using it as well. You may need to make some configuration adjustments, so the emails end up in MailCatcher (check out their documentation for what might apply to your setup).</p>  <p>To send yourself an email for testing, fire up your Rails Console. The format for delivering an email through the console is:</p>  <div class="codez"><code class="terminal">MailerModel.email_name.deliver</code></div>  <p><br /> In the case of Wistia emails, we deliver them to a specific account, so the function looks like <em>MailerModel.email_name(account).deliver</em>. The <em>email_name</em> corresponds to the function within your mailer model.</p>  <p>Changes made in views will appear if you run 'deliver' again, but any changes to the model will require you to re-start the console to take effect.</p>  <p>With MailCatcher, you can see the HTML and text version quickly, and also run analysis to see what devices won't work with elements of your layout. It's super useful.</p>  <p><div class='post_image'> <a href="http://getfile6.posterous.com/getfile/files.posterous.com/temp-2012-06-20/kfamGtknGqjrevmakICshudzwhkgcebgDtJpwtgdFhcvuqeFbAFdHGuulxuc/mailcatcher_snapshot.png.scaled1000.png"><img alt="Mailcatcher_snapshot" height="254" src="http://getfile1.posterous.com/getfile/files.posterous.com/temp-2012-06-20/kfamGtknGqjrevmakICshudzwhkgcebgDtJpwtgdFhcvuqeFbAFdHGuulxuc/mailcatcher_snapshot.png.scaled500.png" width="500" /></a> </div> </p>
  
<h2>Step 3: Set up the layout</h2> <p>So now it's time to get your email looking good. If you're lucky like me, you've got one of the best designers around putting together your table-based layout. If not...my apologies, I haven't found a good way around that step. If you have (found a way to translate div-based layout into tables) please respond in the comments. Otherwise, I'll give you some time to get your table-based layout right.</p>  <p>Save it in your normal <em>app/views/layouts</em> directory 'layout_name.html.erb'. In the spots where you want to add content, I recommend using yields (content_for in your view, see <a href="http://guides.rubyonrails.org/layouts_and_rendering.html" target="_blank">Rails Guides</a> for more). We used yields in three spots: for the image at the top, text content in the body, and link (call-to-action) at the bottom of the email.</p>  <p>All set? Great. In the Mailer model, tell the system to use a layout for HTML emails (and leave the text emails as-is:</p>  <div class="codez"><code class="terminal"> mail(to: '<a href="mailto:foo@bar.org">foo@bar.org</a>', subject: 'something important for you!') do |format| </code></div>  <div class="codez"><code class="terminal">&nbsp; format.html { render layout: 'layout.html.erb' } </code></div>  <div class="codez"><code class="terminal">&nbsp; format.text</code></div>  <div class="codez"><code class="terminal"> end </code></div>  <p><br /> If you haven't created an html version of your mailer, you should do so now - <em>same_name_as_text_version.html.erb</em>. But instead of having to include the entire layout, you can just include the content you'd like to pass in. Ah, much better.</p>  <p>&nbsp;</p>

<h2>Step 4: Commence awesome styling</h2> <p> Ok, so you're setting up great looking email, and testing it in MailCatcher (use their Fractal functionality as well - so cool to know what won't work and on which device). What could be better? Well, you had to use inline styles to get things set up, and if you're anything like me, that drives you just about batshit crazy.  Luckily, the Roadie gem is here to rescue you!</p>  <p><strong><a href="https://github.com/Mange/roadie">Roadie</a></strong> makes using external stylesheets possible with emails. Previously, you had to include ALL styles inline - which was a real pain to look at and maintain. Now, you can use sass to keep track of the styles associated with your emails ... wow!  Add it to your gemfile ('gem roadie') and you're good to go.&nbsp;Ryan Bates does a <a href="http://railscasts.com/episodes/312-sending-html-email?view=asciicast">good screencast</a> on getting set up with roadie (which is where I first heard about it).</p>  <p>I created a new stylesheet (cleverly called 'mail.sass') and moved all my inline styles from the table layout to it. &nbsp;Then, add a link to your stylesheets at the top of the layout (ie. <em>&lt;link rel="stylesheet" type="text/css" href="mail"&gt; </em>) and elements in your layout and views will be styled through a stylesheet. So much cleaner.</p>

<h2>Extra Notes</h2><p>One hurdle we had to jump was in relation to images in email layouts. We encountered some real weirdness using 'image_tag' with just a link to the image. Instead, we ended up building the full URL using <em>'http://#{ ::AppConfig.asset_host }/path_to_image'</em>. Might be helpful if you plan to tackle this project.</p>
